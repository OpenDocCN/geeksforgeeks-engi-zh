# 设计类似 Youtube 的视频分享服务系统

> 原文:[https://www . geesforgeks . org/design-video-sharing-system-like-YouTube/](https://www.geeksforgeeks.org/design-video-sharing-system-like-youtube/)

**视频共享服务系统的目的**

Youtube 是基于广告的视频共享服务，允许用户上传基于视频的媒体内容。用户可以上传、观看、搜索、喜欢、不喜欢的视频，给视频添加评论。用户仅作为注销用户上传/删除视频，但他们可以作为注销用户搜索/观看视频。这项服务是基于广告的免费服务，因此用户在观看视频时会看到广告。此外，用户可以通过他们的帐户跟踪其他用户或频道。此外，用户只有在登录系统时才能向视频添加评论。

在开始设计任何像照片和视频共享社交网络服务系统这样的系统之前，建议详细考虑系统边界和需求，并尝试了解未来(如 5 年或 10 年)系统容量。这非常关键，因为在某个时候，如果系统的用户数量呈指数级增长，系统容量将不足以做出快速响应。在架构设计的背后，你必须考虑五大支柱(可用性、可靠性、弹性、耐用性、性价比)。这些是我们应该一起考虑的支柱，因为它们是相互耦合的。简而言之，可用性意味着系统应该始终可用。可靠性意味着系统应该按预期工作。弹性意味着如果出现任何问题，系统将如何以及何时自我恢复。在我们删除之前，持久性是系统每个部分都应该存在的支柱。性价比也是一个重要的话题，它将基本上关系到在成本效率下使用服务。可以举例说明，如果系统将建立在 AWS 上，并且足以使用 t2 微 EC2 实例，就没有任何理由使用更大的 EC2 实例并支付额外的费用。

**系统的要求和目标**

Youtube 是最大的视频共享服务之一，它现在有很多组件，但这不是它过去的创建方式。每个系统都越来越注重增长，系统的组件将比最初的版本更多。现在我们将设计 Youtube 的主要功能。由于推荐系统、渠道背景、搜索系统都是单独的讨论话题，我们不再赘述。

所以，如果你想设计一个系统，你必须首先定义需求和系统边界。可能你会有一个服务设计文档，你会在这个服务设计文档中定义需求、边界、架构决策和其他。Youtube 是一种视频共享服务，用户可以上传/观看视频。所以你的系统会支持这些功能；

–用户必须能够创建帐户。

–每个注册用户必须有自己的个人帐户页面。

–用户必须能够登录系统并从系统中注销。

–用户登录时必须能够在系统中上传/删除视频。

–用户登录时必须能够在系统中为视频添加评论。

–用户必须能够在登录或注销时在系统中观看视频。

–用户必须能够在登录或注销时搜索视频/用户/群组。

–用户必须能够跟踪频道。

–用户必须能够喜欢/不喜欢视频。

–用户可以喜欢或不喜欢视频，在这种情况下，系统应该保留喜欢、不喜欢、评论、视图的数量，以将这些数量呈现给用户。

–系统必须能够监控。

–系统必须能够支持公共和私人帐户。

–系统必须能够支持公共和私人视频。

当定义系统边界和功能需求时，需要考虑云或承诺选项。你的系统可以；

–100%兑现承诺(您自己的数据中心/服务器)

–100%云(AWS、谷歌云、Azure)

–承诺和云的混合(您可以在迁移过程中同时拥有两者)

如今，云服务凭借云机制优势获得了巨大的普及。这些优点；

–成本效益

–高速

安全

–备份解决方案

–无限存储容量

–许多不同的服务选项。你不需要从头开始创造世界

–可靠性

–耐用性

–弹性

–监控几乎所有服务

–与其他服务轻松的软件集成

如果我们谈论 Youtube、网飞或其他大型可扩展系统，这意味着这些系统将面临巨大的流量。在系统中可能同时存在大量请求，系统应该倾向于在实时体验中响应所有请求。复制、分片和负载平衡器有助于系统的高可用性。我们将在后面讨论这三个特性。

此外，系统应该以最小的延迟做出响应。你想象你是一个用户，你想在 Youtube 上做任何事情，你真的想等很长时间才能得到回应吗？我想你不想等太久，也不想实时体验系统。为了说明这一点，当你在系统中搜索一个视频时，这个系统应该尽快建议相关的视频。

让我们想想设计的界限；

由于大量用户将在系统中观看视频，因此服务将被大量读取，因此系统将保持一致和可靠，这意味着不应有任何数据丢失。此外，服务将是持久，这意味着系统的所有部分都应该存在，直到它们被手动删除。在考虑容量之前，您必须定义服务的目的。即使它对于承诺服务更重要，但对于承诺服务和云服务都很重要，因为您可以根据目的选择正确的服务，根据可用区域定位它们并定义容量。这样的例子有；

–创建比写服务更多的读服务。

–根据操作类型选择服务器类型。

–根据您的容量估计定义缓存策略。

–根据您的需求选择数据库类型(SQL、NoSQL)。

–根据您的容量估计定义备份解决方案。

–根据您的需求等定义数据分片策略…

假设您的用户总数为 1 亿，我们将假设读取流量比写入流量重，并且假设下载和上传数据的比例为 25:1。

我们将假设视频的平均大小是 250 兆字节，因此系统将有；

5 年视频容量；

–5 * 100m * 1 * 250 MB = 120 PB。(假设每个用户每年上传 1 个视频)。

–360 PB，带复制和备份。

此计算只是如何定义系统容量的一个简单示例，我们不会计算每日下载/上传容量和元数据容量，但您应该考虑此计算(以及每日读/写容量估计)以进行服务/数据库扩展。

此外，缓存是返回数据的重要系统。如果您正在构建大型可扩展系统，您必须考虑不同的缓存策略。您可以将 CDN 用作视频内容缓存，将 Redis/Memcache 用作元数据缓存。缓存最大的问题是伸缩(全局缓存机制)和缓存回收策略。如果您在 AWS 上构建您的服务，您可以使用 Cloudfront 作为 CDN(内容缓存)，也可以使用 AWS 上的 elasticache 服务作为元数据缓存。请注意，Cloudfrount 是高度可扩展的 AWS 服务，您不需要使用维护/可伸缩性。AWS 将自行维护和扩展 Cloudfront 服务。

**原料药设计**

在当今世界，许多系统支持移动平台，因此 API 是能够区分开发人员并支持移动支持的最佳选择。我们可以用 REST 或者 SOAP。很多大公司根据自己的系统，更喜欢 REST 或者 SOAP。我们将在下面提到三个主要的应用编程接口:

*1-上传视频(apiKey、标题、描述、categoryID、语言)*

上传视频是我们应该提到的第一个 API。这个 API 基本上有五个主要属性。您可以向上传视频应用编程接口添加更多属性。注意，apiKey 是服务注册账户的开发者密钥。多亏了 apiKey，我们可以消除黑客攻击。UploadVideo 返回 HTTP 响应，演示视频是否上传成功。

*2- 删除视频 （apiKey， videoID）*

检查用户是否有权删除视频。根据您的响应，它将返回 HTTP 响应 200(正常)、202(已接受)(如果操作已排队)或 204(无内容)。

*3- GetVideo (apiKey，query，videocounttoreturn，pageNumber)*

返回包含视频和频道列表信息的 JSON。每个视频资源将有一个标题，创建日期，像计数，总浏览量，所有者和其他元信息。

* *设计视频分享服务的 API 比较多，但是这三个 API 比其他的更重要。其他的应用程序接口将会像视频，添加评论，搜索，推荐等等…

**数据库设计**

定义数据库模式有两种选择。这是 SQL 和 NoSQL。我们可以使用传统的数据库管理系统，如 MsSQL 或 MySQL 来保存数据。如您所知，我们应该将有关视频和用户的信息保存到 RDBMS 中。关于视频的其他信息，称为元数据，也应该保留。现在我们有三个主要的表来保存数据。(注意，我们只是认为 Youtube 的基本属性。我们可以忘记推荐系统)。

**用户**

–用户标识(主键)

–名称(nvarchar)

–年龄(整数)

–电子邮件

–地址(nvarchar)

–注册日期(日期时间)

–上次登录时间(日期时间)

**视频**

–视频标识(主密钥–由 KGS–密钥生成服务生成)

-视频标题(nvarchar)

–尺寸(浮动)

–用户标识(带用户表的外键)

–描述(nvarchar)

–CategoryID(int):请注意，我们可以创建类别表来定义类别

–点赞数(整数)

–不喜欢的数量(整数)

–显示的数字(整数)–我们可以使用大整数来保持显示的数字

-上传日期？(我)

视频注释

–注释(主键)

–用户标识(带用户表的外键)

–视频标识(带视频表的外键)

-如何(nvarchar)

– 评论日期（日期时间）

**系统设计考虑因素**

基于网络的系统有一些基本特征。主要有客户端、网络服务器、应用服务器、数据库和缓存系统。根据系统流量的强度，服务器或服务的数量会增加，负载平衡器会在这些服务器或服务之间分配传入的请求。此外，根据传入请求者的密度，可以使用队列。队列操作有助于用户避免等待更多时间来获得响应。在我们的 Youtube 服务中；

–客户

–网络服务器

–应用服务器

–数据库

–视频存储

–编码服务

–排队

–复制

–冗余

–负载平衡

–切屑

我们可以将服务分三部分来减少响应时间，因为视频上传比视频下载花费更多的时间。视频可以从缓存中下载，从缓存中获取数据是一种快速的方法。客户端基本上是使用系统的用户。网络服务器是满足请求的第一个实体。传入请求可以发生在上传服务、搜索服务或下载服务中。如果我们给异步下载视频的用户一个机会，系统流量就会放松。编码器将上传的视频编码成多种格式。有三种类型的数据库，即视频内容数据库、用户数据库和视频元数据存储。队列过程发生在应用服务器和编码之间。

我们的 Youtube 服务阅读量会很大，我们在构建系统时应该小心。我们的主要目标应该是快速返回视频。我们可以在不同的服务器上保存视频副本来处理流量问题。此外，这确保了该系统的安全性。我们可以使用负载平衡器将流量分配给不同的服务器。该系统可以保留元数据数据库、用户数据库和视频内容数据库的两个副本。我们可以用 CDN 缓存热门数据。

*系统流程图；*

1-客户端发送请求。

2-来自网络服务器的请求得到满足。

3-网络服务器控制缓存。系统上还可以有两个缓存数据库。

4-如果请求发生在缓存中，响应将被重定向到客户端。

5-否则，网络服务器将请求重定向到应用服务器。

6-网络服务器和应用服务器之间可以有负载平衡器。

**如果此请求是搜索或查看服务，它会尝试通过查看元数据数据库和视频内容数据库来查找请求。负载平衡器可以放置在系统的每一层，例如应用服务器和视频内容存储之间，应用服务器和元数据数据库之间，等等…

当服务器响应客户端的请求时，相关数据会根据缓存过程进行缓存。

众所周知，Youtube 是一个巨大的视频分享系统。用户可以上传视频，上传视频的数量逐日呈指数级增长。根据上传的视频，系统中可能还有一个相同的视频。为了消除视频的重复，我们可以实现一个智能算法。例如，当视频进入系统时，算法会自动检查该视频是否已经保存在系统中。如果系统已经有了这个视频，那么我们就不需要保留重复的数据。它使我们免于不必要的空间使用。此外，如果传入的视频包括保存在系统中的视频，那么我们可以将视频分成小块，并且我们只给出对相同视频块的唯一引用来处理复制问题。

复制和备份是我们之前提到的两个重要概念。复制是处理服务或服务器故障的一个非常重要的概念。复制可以应用于数据库服务器、网络服务器、应用服务器、媒体存储等..事实上，我们可以复制系统的所有部分。(像 Route53 这样的一些 AWS 服务，它们本身是高度可用的，所以您不需要考虑 Route53、负载平衡器等的复制..)请注意，复制还有助于系统缩短响应时间。您可以想象，如果我们将传入的请求分成更多的资源，而不是一个资源，系统可以轻松地满足所有传入的请求。此外，每个资源的副本的最佳数量为 3 个或更多。您可以通过将数据保存在不同的可用性区域或 AWS 中的不同区域来提供冗余。

对于缓存策略，我们可以通过使用缓存服务器来使用全局缓存机制。我们可以使用 Redis 或 memcache，但是缓存策略最重要的部分是如何提供缓存回收。如果我们使用全局缓存服务器，我们将保证每个用户在缓存中看到相同的数据，但是如果我们使用全局缓存服务器，会有时间延迟。作为缓存策略，我们可以使用 LRU(最近最少使用)算法。

对于媒体文件缓存，正如我们之前提到的，我们将使用 CDN。CDN 位于不同的边缘位置，因此响应时间比直接从 AWS S3 获取媒体内容要短。

负载平衡器允许根据特定标准将传入的请求重定向到资源。我们可以在系统的每一层使用负载平衡器。如果我们想使用 AWS 负载平衡器服务，AWS 将支持三种不同的负载平衡器类型，它们是:

–网络负载平衡器

–经典负载平衡器(已弃用)

–应用负载平衡器

对于这项服务，应用程序负载平衡器将适合我们的服务，它本身也将处理 AZ 分发。否则你可以使用 NGinx，但你必须实现算法，如果我们想使用 NGinx，你必须提供维护。

我们可以使用负载平衡器；

–在请求和网络服务器之间。

–网络服务器和应用服务器之间。

–应用服务器和数据库之间

–应用服务器和映像存储之间。

–应用服务器和缓存数据库之间。

–我们可以对负载平衡器使用循环方法。循环方法可以防止请求到达失效的服务器，但是循环方法不能处理任何服务器流量过大的情况。我们可以将 Round Robin 方法修改为更智能的方法来处理这个问题。

视频上传是个大过程。它应该与分片机制一起工作，当它失败时，系统应该确保它应该继续从失败点上传视频。

视频编码过程应包括队列操作。当上传的视频到来时，这个新任务被添加到一个队列中，并且队列中的所有任务被一个接一个地从一个队列中取出。

**系统的基本编码**

## 爪哇

T0T6】

**参考:http://highscalability.com/youtube-architecture**

如果你发现任何不正确的地方，或者你想分享更多关于上面讨论的话题的信息，请写评论。